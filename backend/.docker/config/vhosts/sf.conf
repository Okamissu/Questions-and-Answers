<VirtualHost *:80>

    Define server_name symfony.local
    Define basedocroot /home/wwwroot/app
    Define docrootweb ${basedocroot}/public
    Define logdir /var/log/apache2/

    ServerName ${server_name}
    DocumentRoot ${docrootweb}

    ErrorLog ${logdir}/error.log
    CustomLog ${logdir}/access.log combined

    # Pass PHP requests to PHP-FPM
    <FilesMatch \.php$>
        SetHandler "proxy:fcgi://symfony_php:9000"
    </FilesMatch>

    # Deny access to var folder
    <Directory ${basedocroot}/var>
        <IfModule mod_authz_core.c>
            Require all denied
        </IfModule>
        <IfModule !mod_authz_core.c>
            Order deny,allow
            Deny from all
        </IfModule>
    </Directory>

    # Main public directory
    <Directory ${docrootweb}>
        AllowOverride None
        Require all granted

        # Handle Symfony front controller
        RewriteEngine On

        # Pass Authorization header for JWT
        RewriteCond %{HTTP:Authorization} .
        RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

        # Redirect all non-existent files to index.php
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php [QSA,L]

        DirectoryIndex index.php
        Options -MultiViews
    </Directory>

    Undefine server_name
    Undefine basedocroot
    Undefine docrootweb
    Undefine logdir
</VirtualHost>
